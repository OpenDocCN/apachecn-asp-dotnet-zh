# 监控微服务

当一个系统出现问题时，利益相关者会想知道发生了什么，为什么会发生，你能给出的关于如何解决的任何提示或线索，以及如何防止同样的问题在未来再次发生。这是监控的主要用途之一。然而，监控还可以做得更多。

英寸 NET 单片，有多种监控解决方案可供选择。监控目标始终是集中的，监控当然很容易设置和配置。如果某个东西坏了，我们知道该找什么，去哪里找，因为一个系统中只有有限数量的组件，它们的寿命相当长。

然而，微服务是分布式系统，本质上比单片更复杂。因此，在微服务生产环境中，资源利用率以及运行状况和性能监控非常重要。我们可以使用这些诊断信息来检测和纠正问题，还可以发现潜在的问题并防止其发生。监控微服务带来了不同的挑战。在本章中，我们将主要讨论以下主题:

*   监测的必要性
*   微服务中的监控和日志挑战
*   监测战略
*   中微服务的可用工具和策略。NET 监控空间
*   Azure 诊断和应用洞察的使用
*   ELK 堆栈和 Splunk 的简要概述

监控到底是什么意思？监测没有正式的定义；但是，以下内容是合适的:

''Monitoring provides information around the behavior of an entire system or different parts of a system in their operational environment. This information can be used for diagnosing and gaining insight into the different characteristics of a system.''

# 仪器和遥测技术

监控解决方案依赖于仪器和遥测技术。因此，当我们谈论监控微服务时，我们自然也会讨论仪器和遥测数据。日志只不过是一种检测机制。

# 使用仪器

现在让我们看看什么是仪器仪表。检测是向应用程序添加诊断功能的方法之一。它可以正式定义如下:

''Most applications will include diagnostic features that generate custom monitoring and debugging information, especially when an error occurs. This is referred to as instrumentation and is usually implemented by adding event and error handling code to the application."  -MSDN

在正常情况下，可能不需要来自信息事件的数据，因此降低了存储成本和收集数据所需的事务。但是，当应用程序出现问题时，您必须更新应用程序配置，以便诊断和检测系统可以收集信息性事件数据以及错误和警告消息，从而帮助隔离和修复故障。如果问题只是间歇性出现，可能需要在这种扩展报告模式下运行应用程序一段时间。

# 遥感勘测

最基本的遥测技术是收集仪器和测井系统产生的信息的过程。通常，它使用支持大规模扩展和应用服务广泛分布的异步机制来执行。它可以定义如下:

"The process of gathering remote information that is collected by instrumentation is usually referred to as telemetry." -MSDN

在大型复杂的应用程序中，信息通常在数据管道中捕获，并以一种更易于在不同粒度级别上分析和显示的形式存储。这些信息用于发现趋势、深入了解使用情况和性能，以及检测和隔离故障。

Azure 没有直接提供这种遥测和报告系统的内置系统。但是，结合所有 Azure 服务、Azure 诊断和应用洞察所展示的功能，您可以创建遥测机制，从简单的监控机制到全面的仪表板。您需要的遥测机制的复杂性通常取决于应用程序的大小。这基于几个因素，例如角色或虚拟机实例的数量、它使用的辅助服务的数量、应用程序在不同数据中心的分布以及其他相关因素。

# 监测的必要性

微服务是复杂的分布式系统。微服务实施是任何现代信息技术业务的支柱。了解服务的内部及其交互和行为将有助于您使整体业务更加灵活和敏捷。微服务的性能、可用性、规模和安全性会直接影响企业及其收入。因此，监控微服务至关重要。它帮助我们观察和管理服务属性的质量。让我们讨论需要它的场景。

# 健康监测

通过运行状况监控，我们以一定的频率(通常为几秒钟)监控系统及其各个组件的运行状况。这确保了系统及其组件按预期运行。借助详尽的运行状况监控系统，我们可以监控整个系统的运行状况，包括中央处理器、内存利用率等。它可能以 pings 或广泛的健康监控端点的形式出现，这些端点会发出服务的健康状态以及一些有用的元数据。

对于健康监控，我们可以使用请求失败和成功的比率；我们还可以利用合成用户监控等技术。我们将在本章稍后部分看到合成用户监控。

健康监测的指标基于成功率或失败率的阈值。如果参数值超出配置的阈值，则会触发警报。很有可能会因为这一故障而触发一些维护系统健康的预防措施。此操作可能是在故障状态下重新启动服务，或者提供一些服务器资源。

# 可用性监控

可用性监控与我们刚刚讨论的健康状态监控非常相似。然而，微妙的区别在于，在可用性监控中，重点是系统的可用性，而不是当时的运行状况快照。

系统的可用性取决于各种因素，例如应用程序、服务和服务依赖关系的整体性质和领域，以及基础架构或环境。可用性监控系统捕获与这些因素相关的低级数据点，并表示它们，以便使业务级功能可用。可用性监控参数通常用于跟踪业务指标和**服务级别协议** ( **服务级别协议**)。

# 性能监控

系统的性能通常由关键的性能指标来衡量。任何大型网络系统的一些关键性能指标如下:

*   每小时服务的请求数
*   每小时服务的并发用户数
*   用户执行业务交易(例如下订单)所需的平均处理时间

此外，性能还通过系统级参数来衡量，例如:

*   中央处理器利用率
*   内存利用率
*   输入输出速率
*   排队的消息数

如果系统不满足这些关键性能指标中的任何一个，就会发出警报。

通常，在分析性能问题时，监控系统从以前的基准中获取的历史数据用于故障排除。

# 安全监控

监控系统可以检测异常的数据模式请求、异常的资源消耗模式，并检测对系统的攻击。具体来说，在拒绝服务的情况下，可以预先识别攻击或注入攻击，并向团队发出警报。安全监控还保留经过身份验证的用户的审计跟踪，并保留已签入和签出系统的用户的历史记录。它还可以方便地满足合规性要求。

安全性是分布式系统(包括微服务)的一个交叉问题，因此在系统中有多种方式生成这些数据。安全监控可以从各种工具中获取数据，这些工具不是系统的一部分，但可能是托管系统的基础架构或环境的一部分。不同类型的日志和数据库条目可以作为数据源。然而，这确实取决于系统的性质。

# 服务水平协议监控

具有服务级别协议的系统基本上保证了某些特性，例如性能和可用性。对于基于云的服务，这是一个非常常见的场景。本质上，服务级别协议监控就是监控系统的那些有保证的服务级别协议。服务水平协议监控是作为服务提供商和消费者之间的合同义务来实施的。

它通常基于可用性、响应时间和吞吐量来定义。SLA 监控所需的数据点可以来自性能端点监控或日志记录以及监控参数的可用性。对于内部应用程序，许多组织跟踪因服务器停机而引发的事件数量。针对这些事件采取的行动的**根本原因分析** ( **RCA** )降低了重复这些问题的风险，并有助于满足服务级别协议。

出于内部目的，组织还可以跟踪导致服务失败的事件的数量和性质。了解如何快速解决或完全消除这些问题有助于减少停机时间并满足服务级别协议。

# 审核敏感数据和关键业务交易

出于任何法律义务或合规性原因，系统可能需要对系统中的用户活动进行审计跟踪，并记录他们的所有数据访问和修改。由于审计信息本质上是高度敏感的，它可能只向系统中的少数特权和受信任的个人披露。审计跟踪可以是安全子系统的一部分，也可以单独记录。您可能需要按照法规或合规性规范的规定，以特定的格式传输和存储审计线索。

# 最终用户监控

在终端用户监控中，跟踪并记录终端用户对系统功能的使用和/或整个系统的使用情况。使用情况监控可以使用各种用户跟踪参数来完成，例如使用的功能、为指定用户完成关键事务所需的时间，甚至是强制的配额。强制配额是在系统使用方面对最终用户施加的约束或限制。一般来说，各种现收现付服务使用强制配额；例如，一次免费试用，您最多只能上传 25 MB 的文件。此类监控的数据源通常是根据日志和跟踪用户行为收集的。

# 排除系统故障

系统的最终用户可能会遇到系统故障。这可能是系统故障，也可能是用户无法执行某项活动。使用系统日志监控这类问题；如果没有，最终用户将需要提供详细的信息报告。此外，有时服务器崩溃转储或内存转储会非常有帮助。然而，在分布式系统的情况下，理解故障的确切根源会有点困难。

在许多监控场景中，仅使用一种监控技术是无效的。最好使用多种监控技术和工具进行诊断。特别是，监控分布式系统非常具有挑战性，需要来自各种来源的数据。除了正确分析情况和决定行动要点之外，我们还必须考虑整体的监控观点，而不是只从一种系统角度来看。

既然我们对通用监控需要做些什么有了更好的了解，让我们重新审视一下微服务的视角。因此，我们将讨论微服务架构风格带来的不同监控挑战。

# 监测挑战

微服务监控提出了不同的挑战。会有这样的场景:一个服务可能依赖于另一个服务，或者客户端向一个服务发送请求，而响应来自另一个服务，这会使操作变得复杂；因此，扩展微服务在这里将是一项具有挑战性的任务。类似地，流程实现，比如说 DevOps，在实现一个巨大的企业微服务应用程序时将是一项具有挑战性的工作。因此，让我们在这一部分讨论这些挑战。

# 规模

一种服务可能依赖于其他各种微服务提供的功能。这就产生了复杂性，这在。NET 整体系统。检测所有这些依赖关系相当困难。伴随规模而来的另一个问题是变化率。随着持续部署和基于容器的微服务的发展，代码始终处于可部署状态。容器只能存活几分钟，甚至几秒钟。虚拟机也是如此。虚拟机的寿命约为几分钟到几小时。

在这种情况下，测量常规信号，如每分钟的 CPU 使用率和内存消耗使用率，是没有意义的。有时，容器实例可能一分钟都不存在。一分钟之内，容器实例可能已经被处理掉了。这是微服务监控的挑战之一。

# DevOps 心态

传统上，服务或系统一旦部署，就归运营团队所有和管理。然而，DevOps 打破了开发人员和运营团队之间的孤岛。它伴随着许多实践，例如持续集成和持续交付，以及持续监控。伴随这些新实践而来的是新的工具集。

然而，DevOps 不仅仅是一套实践或工具；更重要的是，这是一种心态。改变人们的心态总是一个艰难而缓慢的过程。微服务监控也需要类似的思维转变。

随着服务自治的出现，开发团队现在不得不拥有服务。这也意味着他们必须解决开发问题，并关注服务的所有操作参数和服务级别协议。仅仅通过使用最先进的监控工具，开发团队不会在一夜之间改变。运营团队也是如此。不会一夜之间突然变成*核心平台团队*(或者随便你喜欢什么花哨的名字)。

为了使微服务对组织、开发人员和运营部门来说成功且有意义，团队需要相互帮助，了解各自的痛点，并朝同一个方向思考，即如何共同为业务带来价值。没有服务的规范，监控就不可能发生，这是开发团队可以提供帮助的地方。同样，没有运营团队的帮助，运营指标和运行手册的警报和设置也不会发生。这是交付微服务监控解决方案的挑战之一。

# 数据流可视化

市场上有许多用于数据流可视化的工具。其中有 AppDynamics、New Relic 等等。这些工具能够处理 10 到 100 个微服务的可视化。然而，在更大的环境中，有成千上万的微服务，这些工具无法处理可视化。这是微服务监控的挑战之一。

# 监控工具测试

我们信任监控工具，因为我们知道它们描述了我们的微服务实现的全貌。然而，为了确保他们保持这种理解，我们将不得不测试监控工具。这在整体实现中从来不是一个挑战。然而，当涉及到微服务时，出于监控的目的，需要对微服务进行可视化。这意味着产生假的/合成的交易和时间，并利用整个基础设施，而不是为客户服务。因此，监控工具的测试是一件昂贵的事情，并且在微服务监控中提出了重大挑战。

# 监测战略

在这一节中，我们将了解使微服务可见的监控策略。通常实施以下或更多策略来创建定义明确的整体监控解决方案。

# 应用/系统监控

这种策略也被称为基于**框架的策略**。在这里，应用程序，或者在我们的例子中是微服务，本身在给定的执行上下文中生成监控信息。可以基于应用程序数据中的阈值或触发点动态配置应用程序，这可以生成跟踪语句。也可以有一个基于探针的框架(例如。NET CLR，它提供了获取更多信息的钩子)来生成监控数据。因此，有效的检测点本身可以嵌入到应用程序中，以促进这种监控。除此之外，承载微服务的底层基础设施也可能引发关键事件。这些事件可以由与应用程序位于同一台主机上的监控代理监听和记录。

# 真实用户监控

这种策略基于系统中真实的最终用户事务流。当终端用户实时使用该系统时，可以使用它捕获与响应时间和延迟相关的参数，以及用户遇到的错误数量。

这对于特定的故障排除和问题解决非常有用。通过这种策略，系统的热点和服务交互瓶颈也可以被捕获。可以记录整个端到端用户流或事务，以便稍后重放。这样做的好处是，这些类型的录制播放可以用于故障排除以及各种类型的测试目的。

# 语义监控和合成交易

语义监控策略侧重于业务事务；但是，它是通过使用合成事务来实现的。顾名思义，在语义监控中，我们试图模拟最终用户流。但是，这是以一种受控的方式和虚拟数据来完成的，因此您可以将流的输出与实际的最终用户流数据区分开。这种策略通常用于服务依赖、运行状况检查以及对整个系统中出现的问题进行诊断。为了实现合成交易，我们需要在规划流程时小心谨慎；此外，我们需要足够小心，不要让系统压力过大。这里有一个例子:为假产品目录创建假订单，并观察整个事务在系统中传播的响应时间和输出。

# 压型

这种方法特别侧重于解决整个系统的性能瓶颈。这种方法不同于前面的方法。真实和语义监控侧重于系统的业务事务或功能方面，并围绕它收集数据。相反，概要分析是关于系统级或低级信息捕获的。其中一些参数是响应时间、内存或线程。这种方法在应用程序代码或框架中使用探测技术并收集数据。利用分析过程中捕获的数据点，相关的 DevOps 团队可以确定性能问题的原因。在生产环境中应避免使用探测进行分析。然而，它非常适合生成调用时间等等，而不会在运行时使系统过载。一般来说，概要分析的一个很好的例子是一个用 ASP.NET 迷你概要分析器，甚至是用窥镜分析的 ASP.NET MVC 应用程序。

# 端点监控

通过这种方法，我们公开了服务的一个或多个端点，以发出与服务本身以及基础设施参数相关的诊断信息。通常，不同的端点专注于提供不同的信息。例如，一个端点可以给出服务的健康状态，而另一个端点可以提供该服务执行中出现的 HTTP 500 错误信息。对于微服务来说，这是一种非常有用的技术，因为它从本质上改变了从推送模型到拉取模型的监控，并降低了服务监控的开销。我们可以在一定的时间间隔内从这些端点中删除数据，并构建一个仪表板，为运营指标收集数据。

# 记录

日志是一种由系统、其各种组件或基础结构层提供的工具。在本节中，我们将首先讨论日志记录挑战，然后讨论解决这些挑战的策略。

# 日志挑战

我们将首先尝试理解微服务中日志管理的问题:

*   为了记录与系统事件和参数以及基础设施状态相关的信息，我们需要保存日志文件。传统意义上。NET 单片，日志文件保存在部署应用程序的同一台机器上。在微服务的情况下，它们托管在虚拟机或容器上。但是虚拟机和容器都是短暂的，这意味着它们不能保持状态。在这种情况下，如果我们用虚拟机或容器保存日志文件，我们将丢失它们。这是微服务中日志管理的挑战之一。
*   在微服务架构中，有许多服务构成了一个事务。假设我们有一个下单交易，服务 A、服务 B 和服务 C 参与交易。比如说，如果服务 B 在事务期间失败了，我们如何在日志中理解和捕获这个失败？不仅如此，更重要的是，我们将如何理解服务 B 的一个特定实例已经失败，并且它正在参与所述事务？这种情况给微服务带来了另一个挑战。

# 日志策略

到目前为止，在本节中，我们已经讨论了日志记录、它的挑战以及为什么我们应该实现日志记录。同时进行多个调用是可能的，因此当我们实现日志记录时，我们应该以这样一种方式来实现它，即我们知道所记录事务的确切来源。我们将使用关联标识进行记录。

Logging is not related to microservices specifically; it is also important for monolithic applications.

为了在微服务中实现日志记录，我们可以使用下面几节中讨论的密钥记录策略。

# 集中式日志记录

集中日志记录和集中监控是有区别的。在集中式日志记录中，我们记录系统中发生的事件的所有详细信息——它们可能是错误或警告，或者只是为了提供信息——而在集中式监视中，我们监视关键参数，即特定信息。

通过日志，我们可以了解系统或特定事务中实际发生了什么。我们会有具体交易的所有细节，比如为什么开始，是谁触发的，记录了什么样的数据或者资源等等。在复杂的分布式系统中，例如微服务，这确实是关键的信息，我们可以用它来解决信息流或错误的整个难题。我们还需要将超时、异常和错误视为需要记录的事件。

我们记录的关于特定事件的信息也应该是结构化的，并且这个结构应该在我们的系统中是一致的。因此，例如，我们的结构化日志条目可能包含基于级别的信息，以说明日志条目是用于信息、错误，还是作为日志条目事件记录的调试信息或统计信息。结构化日志条目还必须有日期和时间，以便我们知道事件发生的时间。我们还应该在结构化日志中包含主机名，以便我们确切地知道日志条目来自哪里。我们还应该包括服务名称和服务实例，这样我们就可以准确地知道哪个微服务创建了日志条目。

最后，我们还应该在结构化日志格式中包含一条消息，这是与事件相关的关键信息。例如，对于一个错误，这可能是调用堆栈或关于异常的细节。关键是我们保持结构化日志格式的一致性。一致的格式将允许我们查询日志信息。然后，我们基本上可以使用我们的集中式日志工具来搜索特定的模式和问题。微服务架构中集中式日志记录的另一个关键方面是使分布式事务更具可追溯性。

# 在日志记录中使用关联标识

关联标识是分配给每个事务的唯一标识。因此，当一个事务跨多个服务分布时，我们可以使用日志信息跨不同的服务跟踪该事务。关联 ID 基本上是从服务传递到服务的。处理该特定事务的所有服务都接收相关标识，并将其传递给下一个服务，以此类推，这样它们就可以将与该事务相关联的任何事件记录到我们的集中日志中。当我们必须可视化和理解这个事务在不同的微服务之间发生了什么时，这极大地帮助了我们。

# 语义日志

【Windows 的事件跟踪 ( **ETW** )是一种结构化日志机制，您可以在其中存储带有日志条目的结构化有效负载。此信息由事件侦听器生成，可能包括关于事件的类型化元数据。这只是语义日志的一个例子。语义日志记录将附加数据与日志条目一起传递，以便处理系统可以获得围绕事件构建的上下文。因此，语义日志也被称为结构化日志或类型化日志。

For more information, refer to [https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-](https://docs.microsoft.com/en-us/windows-hardware/drivers/devtest/event-tracing-for-windows--etw-)

例如，指示已下订单的事件可以生成一个日志条目，其中包含作为整数值的项目数、作为十进制数的总值、作为长数值的客户标识符以及作为字符串值的交货城市。订单监控系统可以读取有效负载并轻松提取单个值。ETW 是 Windows 附带的标准功能。

在 Azure Cloud 中，可以从 ETW 获取日志数据源。由微软模式和实践团队开发的语义日志应用程序块是一个框架的例子，它使全面的日志记录变得更加容易。当您将事件写入自定义事件源时，语义日志记录应用程序块会检测到这一点，并允许您将事件写入其他日志记录目标，如磁盘文件、数据库、电子邮件等。您可以在中编写的 Azure 应用程序中使用语义日志记录应用程序块。NET 并在 Azure 网站、云服务和虚拟机上运行。

# Azure 云中的监控

Azure 或任何云提供商都没有单一的现成解决方案或产品来应对微服务带来的监控挑战。有趣的是，没有太多的开源工具可以使用。基于. NET 的微服务。

我们正在利用微软 Azure 云和云服务来构建我们的微服务，因此寻找它附带的监控功能非常有用。如果您希望管理大约几百个微服务，可以利用基于微软 Azure 解决方案的定制监控解决方案(主要是交织 PowerShell 脚本)。

我们将主要关注以下日志记录和监控解决方案:

*   微软 Azure 诊断:这有助于通过资源和活动日志收集和分析资源。
*   应用洞察:这有助于收集和分析我们微服务的所有遥测数据。这是一种基于框架的监控方法。
*   日志分析:日志分析分析和显示数据，并对收集的日志提供可扩展的查询功能。

让我们从不同的角度来看这些解决方案。这个视角将帮助我们可视化我们基于 Azure 的微服务监控解决方案。微服务由以下内容组成:

*   基础设施层:虚拟机或应用程序容器(例如，Docker 容器)
*   应用程序堆栈层:构成操作系统，。和微服务应用程序代码

这些层组件中的每一个都可以按如下方式进行监控:

*   虚拟机:使用 Azure 诊断日志
*   Docker 容器:使用容器日志和应用洞察或第三方容器监控解决方案，如 cAdvisor、Prometheus 或 Sensu
*   Windows 操作系统:使用 Azure 诊断日志和活动日志
*   微服务应用:使用应用洞察
*   数据可视化和指标监控:使用日志分析或第三方解决方案，如 Splunk 或 ELK 堆栈

各种 Azure 服务的日志条目中都有一个活动标识。此活动标识是为每个请求分配的唯一 GUID，可以在日志分析期间用作关联标识。

# 微软 Azure 诊断

Azure 诊断日志使我们能够为部署的微服务收集诊断数据。我们还可以使用诊断扩展从各种来源收集数据。网络和工作者角色、Azure 虚拟机以及所有 Azure 应用服务都支持 Azure 诊断。其他 Azure 服务有自己独立的诊断。

启用 Azure 诊断日志和探索 Azure 应用程序服务中的各种设置很容易，并且可以作为切换开关使用，如下图所示:

![](assets/2c18c643-fb74-4a97-a371-5427ddef4ec5.png)

Azure 诊断程序可以从以下来源收集数据:

*   性能计数器
*   应用程序日志
*   Windows 事件日志
*   。NET 事件源
*   IIS 日志
*   基于清单的 ETW
*   崩溃转储
*   自定义错误日志
*   Azure 诊断基础架构日志

# 使用 Azure 存储存储诊断数据

Azure 诊断日志不会永久存储。它们是翻转日志，也就是说，它们会被更新的日志覆盖。所以，如果我们想在任何分析工作中使用它们，我们必须存储它们。Azure 诊断日志可以存储在文件系统中，也可以通过 FTP 传输；更好的是，它可以存储在 Azure 存储容器中。

有不同的方法可以为指定的 Azure 资源(在我们的例子中，是 Azure 应用服务上托管的微服务)指定用于诊断数据的 Azure 存储容器。这些措施如下:

*   命令行界面工具
*   管理员
*   Azure 资源管理器
*   带有 Azure SDK 2.9 或更高版本的 Visual Studio 2017
*   蓝色门户网站

# 使用 Azure 门户

下面的截图描述了通过 Azure 门户调配的 Azure 存储容器:

![](assets/be4d9ee8-fc83-4d1a-845c-02b930ab472b.png)

# 指定存储帐户

指定存储应用特定诊断数据的存储帐户的另一种方法是在`ServiceConfiguration.cscfg`文件中指定存储帐户。这也很方便，因为在开发期间，您可以指定存储帐户。还可以在开发和生产过程中指定完全不同的存储帐户。在部署过程中，Azure 存储帐户也可能被配置为动态环境变量之一。

帐户信息在配置设置中被定义为连接字符串。以下示例显示了在 Visual Studio 中为新的微服务项目创建的默认连接字符串:

```
<ConfigurationSettings>
  <Setting name="Microsoft.WindowsAzure.Plugins.
  Diagnostics.ConnectionString" value="UseDevelopmentStorage=true" />
</span></ConfigurationSettings>
```

您可以更改此连接字符串以提供 Azure 存储帐户的帐户信息。

现在，让我们看看 Azure 存储是如何存储诊断数据的。所有日志条目都存储在 blob 或表存储容器中。存储选择可以在我们创建和关联 Azure 存储容器时指定。

# 诊断数据的 Azure 存储模式

用于存储诊断数据的 Azure 表存储的结构如下:

如果存储是表的形式，我们将看到以下表模式:

*   WadLogsTable:该表存储代码执行期间使用跟踪侦听器编写的日志语句。
*   此表指定了诊断监视器和配置更改。
*   此表包括诊断监视器正在监视的目录。这包括 IIS 日志、IIS 失败的请求日志和自定义目录。blob 日志文件的位置在容器字段中指定，blob 的名称在 RelativePath 字段中指定。绝对路径字段指示文件在 Azure 虚拟机上的位置和名称。
*   WADPerformanceCountersTable:此表包含与配置的性能计数器相关的数据。
*   此表包含 Windows 的事件跟踪日志条目。

对于 blob 存储容器，诊断存储模式如下:

*   wad-control-container:这仅适用于 SDK 2.4 和之前的版本。它包含控制 Azure 诊断的 XML 配置文件。
*   这包含来自 iis 失败的请求日志的信息。
*   这包含了关于 iis 日志的信息。
*   自定义:这是基于诊断监视器监视的配置目录的自定义容器。这个 blob 容器的名称将在 WADDirectoriesTable 中指定。

这里需要注意的一个有趣的事实是，可以在这些容器表或 blobs 上看到的 WAD 后缀来自微软 Azure Diagnostics 以前的产品名称，即 Windows Azure Diagnostics。

You can use *Cloud Explorer* from Visual Studio to explore the stored Azure diagnostics data.

# 应用洞察简介

Application Insights 是微软提供的一款**应用性能管理** ( **APM** )产品。这是一项用于监控性能的有用服务。基于. NET 的微服务。这有助于理解单个微服务的内部操作行为。它将调整服务性能并了解微服务的性能特征，而不是仅仅关注于检测和诊断问题。这是基于框架的监测方法的一个例子。这意味着在微服务的开发过程中，我们将把应用洞察包添加到我们微服务的 Visual Studio 解决方案中。这就是 Application Insights 如何为遥测数据测量您的微服务。这可能并不总是每个微服务的理想方法；但是，如果您没有仔细考虑监控您的微服务，它就派上了用场。这样，您的服务就可以开箱即用地进行监控。

借助应用洞察，您可以收集和分析以下类型的遥测数据类型:

*   HTTP 请求率、响应时间和成功率
*   依赖(HTTP 和 SQL)调用率、响应时间和成功率
*   服务器和客户端的异常跟踪
*   诊断日志跟踪
*   页面视图计数、用户和会话计数、浏览器加载时间和异常
*   AJAX 调用率、响应时间和成功率
*   服务器性能计数器
*   自定义客户端和服务器遥测
*   按客户端位置、浏览器版本、操作系统版本、服务器实例、自定义维度等进行细分
*   可用性测试

除了上述类型之外，还有相关的诊断和分析工具，可用于使用各种不同的可定制指标进行警报和监控。借助自己的查询语言和可定制的仪表板，Application Insights 为提供了一个很好的监控解决方案。NET 微服务。

# 其他微服务监控解决方案

现在让我们来看看一些流行的监控解决方案，它们可以用来构建定制的微服务监控解决方案。显然，这些解决方案并不是现成的；然而，它们肯定是经过开源社区时间考验的，并且可以很容易地集成到其中。基于. NET 的环境。

# ELK 堆栈概述

正如我们所看到的，监视的基本工具之一是日志。对于微服务，将会产生数量惊人的日志，这些日志有时甚至是人类无法理解的。ELK 堆栈(也称为弹性堆栈)是最流行的日志管理平台。它也是微服务监控的一个很好的候选，因为它具有聚合、分析、可视化和监控的能力。ELK 堆栈是一个工具链，包括三个不同的工具，即 Elasticsearch、Logstash 和 Kibana。让我们逐一了解它们在 ELK 堆栈中的角色。

# 弹性搜索

Elasticsearch 是一个基于 Apache Lucene 库的全文搜索引擎。该项目是开源的，用 Java 开发。Elasticsearch 支持水平缩放、多租户和聚类方法。弹性搜索的基本要素是它的搜索索引。这个索引以 JSON 的形式存储在内部。单个 Elasticsearch 服务器存储多个索引(每个索引代表一个数据库)，单个查询可以搜索具有多个索引的数据。

Elasticsearch 确实可以提供接近实时的搜索，并且可以以非常低的延迟进行扩展。搜索和结果编程模型通过弹性搜索应用编程接口公开，并通过 HTTP 提供。

# logstash(日志记录)

Logstash 在 ELK 堆栈中扮演日志聚合器的角色。它是一个日志聚合引擎，收集、分析、处理日志条目并将其保存在其持久存储中。由于其基于数据管道的架构模式，Logstash 非常广泛。它被部署为代理，并将输出发送到 Elasticsearch。

# 姆纳人

Kibana 是一个开源的数据可视化解决方案。它是为弹性搜索而设计的。您可以使用 Kibana 来搜索、查看和交互弹性搜索索引中存储的数据。

它是一个基于浏览器的 web 应用程序，允许您执行高级数据分析，并在各种图表、表格和地图中可视化您的数据。此外，它是一个零配置应用程序。因此，它在安装后既不需要任何编码，也不需要额外的基础设施。

# 软体

Splunk 是最好的商业日志管理解决方案之一。它可以非常容易地处理万亿字节的日志数据。随着时间的推移，它增加了许多额外的功能，现在被认为是成熟的运营智能领先平台。Splunk 用于监控大量应用程序和环境。

它在实时监控任何基础架构和应用程序方面发挥着至关重要的作用，对于在问题、问题和攻击影响客户、服务和盈利能力之前识别它们至关重要。Splunk 的监控能力、具体模式、趋势和阈值等等都可以建立为 Splunk 需要关注的事件。这是为了让特定的个人不必手动完成这项工作。

Splunk 在其平台中包含了警报功能。它可以实时触发警报通知，以便采取适当的措施来避免应用程序或基础架构停机。

根据配置的警报和操作触发器，Splunk 可以:

*   发送电子邮件
*   执行脚本或触发运行手册
*   创建组织支持或行动单

通常，Splunk 监控标记可能包括以下内容:

*   应用程序日志
*   活动目录更改事件数据
*   Windows 事件日志
*   Windows 性能日志
*   基于 WMI 的数据
*   Windows 注册表信息
*   来自特定文件和目录的数据
*   性能监控数据
*   从 API 和其他远程数据接口和消息队列获取数据的脚本输入

# 发信号

与任何监控解决方案一样，Splunk 也具有警报功能。它可以配置为基于任何实时或历史搜索模式设置警报。这些警报查询可以定期自动运行，警报可以由这些实时或历史查询的结果触发。

您可以将 Splunk 警报基于各种基于阈值和趋势的情况，例如条件、关键服务器或应用程序错误，或者资源利用率的阈值。

# 报告

Splunk 可以报告已经触发和执行的警报，以及它们是否满足某些条件。Splunk 的警报管理器可用于根据前面的警报数据创建报告。

# 摘要

微服务的调试和监控并不简单；这是一个具有挑战性的问题。我们故意用*这个词来挑战*:这个没有银弹。没有一个你可以安装的工具可以像魔法一样工作。但是，借助 Azure 诊断和应用洞察，或者 ELK 堆栈或 Splunk，您可以提出解决方案，帮助您解决微服务监控挑战。实现微服务监控策略，例如应用程序/系统监控、真实用户监控、合成事务、集中日志记录、语义日志块，以及在整个事务性 HTTP 请求中实现相关标识，是监控微服务实现的一种有用方式。

在下一章中，我们将了解如何扩展微服务，以及扩展微服务解决方案的解决方案和策略。